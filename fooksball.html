<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Top-Down Football</title>
  <style>
    /* Full-viewport setup */
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%; 
      width: 100%;
      background: #006400; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }

    /* Canvas fills the entire viewport height; width auto-scales. */
    #gameCanvas {
      display: block;
      height: 100vh;  /* 100% of viewport height */
      width: auto;    /* keep aspect ratio */
      margin: 0 auto; /* center horizontally */
      background-color: #007f0e; /* field color */
      border: 2px solid #fff;
      box-sizing: border-box;
    }

    /* Simple overlay for scoreboard & controls */
    #uiOverlay {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 9999;
      text-align: center;
      pointer-events: none; /* let clicks pass through except on child elements */
    }
    #scoreboard, #controls {
      display: inline-block;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 6px 12px;
      margin: 5px;
      border-radius: 8px;
      pointer-events: auto; /* allow clicks */
    }
    button {
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #scoreboard span {
      margin: 0 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="uiOverlay">
  <div id="scoreboard">
    <span id="offenseScore">Offense: 0</span>
    <span id="defenseScore">Defense: 0</span>
    <span id="quarter">Q1</span>
    <span id="gameClock">15:00</span>
    <span id="downDistance">1 & 10</span>
  </div>
  <br>
  <div id="controls">
    <button id="playRun" style="display:none;">Run Play</button>
    <button id="playPass" style="display:none;">Pass Play</button>
  </div>
</div>

<script>
/*
  Overall Approach:
  - "Field coordinates" are 1200 px tall (0..1200), 530 px wide (0..530).
  - We transform to actual canvas size for drawing only (in draw functions).
  - 4 quarters, each 15 min, clock runs in "play" phase.
  - I-Formation on offense, 4-3 on defense. 
  - Snap the ball by tapping the center (#70). 
  - If run selected, RB (#22) gets the handoff automatically, tries to run upfield, 
    but you can tap the field to change his target. 
  - If pass selected, the QB (#12) retains possession, 
    WRs (#80, #82) & TE (#87) run routes, 
    tapping one of them “throws” the ball. 
  - Defense pursues the ball carrier. 
*/

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

/** FIELD DIMENSIONS **/
const FIELD_HEIGHT = 1200;
const FIELD_WIDTH = 530;

/** Game State Object **/
let gameState = {
  phase: "pre-snap",   // "pre-snap", "play", "post-play"
  quarter: 1,
  totalQuarters: 4,
  clock: 15 * 60,      // 15:00 in seconds
  offenseScore: 0,
  defenseScore: 0,
  down: 1,
  yardsToFirstDown: 10,

  // Start line of scrimmage somewhere in the lower half
  lineOfScrimmage: 800,
  // 10 yards up from LOS = 100 px up from lineOfScrimmage
  firstDownMarker: 700,

  lastTime: 0,

  playType: null,  // "run" or "pass"
};

let ball = {
  x: 0,
  y: 0,
  possessor: null, // the Player object who has it
  inFlight: false, // true while traveling in the air
  vx: 0,
  vy: 0,
  update(dt) {
    if (this.possessor) {
      this.x = this.possessor.x;
      this.y = this.possessor.y;
    } else if (this.inFlight) {
      // Move ball
      this.x += this.vx * dt;
      this.y += this.vy * dt;
    }
  }
};

/** Player class **/
class Player {
  constructor({ x, y, role, number, team }) {
    this.x = x; 
    this.y = y;
    this.role = role;
    this.number = number;
    this.team = team; // "offense" / "defense"
    this.speed = 80;  // px/sec
    if (this.role==="WR") this.speed = 100;
    if (this.role==="OL" || this.role==="DL") this.speed = 60;
    if (this.role==="LB") this.speed = 75;
    if (this.role==="CB" || this.role==="S") this.speed = 90;

    this.target = null;   // if set, we move toward it
    this.routeFn = null;  // pass route function
    this.routeTime = 0;   // track time on route
  }

  update(dt) {
    if (gameState.phase!=="play") return;

    if (this.team==="offense") {
      // If I'm the ball carrier
      if (ball.possessor===this) {
        // If user tapped a target location, follow it
        if (this.target) {
          moveToward(this, this.target.x, this.target.y, this.speed, dt);
          let d = dist(this.x, this.y, this.target.x, this.target.y);
          if (d < 10) this.target = null;
        } else {
          // Otherwise, keep running upfield
          moveToward(this, this.x, 0, this.speed, dt);
        }
      }
      // If I'm a WR/TE in pass mode, run route
      else if (gameState.playType==="pass" && (this.role==="WR"||this.role==="TE")) {
        if (this.routeFn) {
          this.routeTime += dt;
          let desired = this.routeFn(this, this.routeTime);
          if (desired) {
            moveToward(this, desired.x, desired.y, this.speed, dt);
          }
        }
      } 
      // else if I'm OL or something, minimal movement
    } else {
      // Defense: if there's a ball carrier, pursue
      if (ball.possessor && ball.possessor.team==="offense") {
        let bc = ball.possessor;
        moveToward(this, bc.x, bc.y, this.speed, dt);
      }
    }
  }

  draw(ctx) {
    let scale = getScale();
    let sx = this.x * scale.sx;
    let sy = this.y * scale.sy;

    ctx.beginPath();
    ctx.arc(sx, sy, 12, 0, 2*Math.PI);
    ctx.fillStyle = (this.team==="offense") ? "blue" : "red";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();
    ctx.closePath();

    ctx.fillStyle = "#fff";
    ctx.font = "14px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(this.number, sx, sy);
  }
}

/** We'll hold all players in an array **/
let players = [];

/** I-Formation Offense, 4-3 Defense example **/
function initFormation() {
  players = [];
  const los = gameState.lineOfScrimmage;
  const midX = FIELD_WIDTH/2;

  // Offense: I-Form
  // 5 OL across the line
  let OLxStart = midX - 2*30;
  for (let i=0; i<5; i++){
    players.push(new Player({
      x: OLxStart + i*30,
      y: los + 10,
      role: "OL",
      number: 70+i, // 70..74
      team: "offense"
    }));
  }
  // designate the center (first in that loop) as Snapper
  players[0].role = "Snapper";

  // QB behind center
  players.push(new Player({
    x: midX,
    y: los + 60,
    role: "QB",
    number: 12,
    team: "offense"
  }));
  // FB behind QB
  players.push(new Player({
    x: midX,
    y: los + 100,
    role: "FB",
    number: 44,
    team: "offense"
  }));
  // RB behind FB (tailback)
  players.push(new Player({
    x: midX,
    y: los + 140,
    role: "RB",
    number: 22,
    team: "offense"
  }));
  // TE on right
  players.push(new Player({
    x: midX + 80,
    y: los + 10,
    role: "TE",
    number: 87,
    team: "offense"
  }));
  // WR left
  players.push(new Player({
    x: midX - 150,
    y: los,
    role: "WR",
    number: 80,
    team: "offense"
  }));
  // WR right
  players.push(new Player({
    x: midX + 150,
    y: los,
    role: "WR",
    number: 82,
    team: "offense"
  }));

  // Defense (4-3)
  // D-line
  let dLineY = los - 30;
  let dLineXStart = midX - 1.5*30;
  for (let i=0; i<4; i++){
    players.push(new Player({
      x: dLineXStart + i*30,
      y: dLineY,
      role: "DL",
      number: 90 + i, // 90..93
      team: "defense"
    }));
  }
  // LBs
  let lbY = los - 70;
  let lbXStart = midX - 30;
  for (let i=0; i<3; i++){
    players.push(new Player({
      x: lbXStart + i*30,
      y: lbY,
      role: "LB",
      number: 50 + i, // 50..52
      team: "defense"
    }));
  }
  // DBs
  // corners wide, safeties central
  let dbY = los - 130;
  players.push(new Player({ x: midX-180, y: dbY, role:"CB", number:20, team:"defense" }));
  players.push(new Player({ x: midX+180, y: dbY, role:"CB", number:21, team:"defense" }));
  players.push(new Player({ x: midX-50,  y: dbY-40, role:"S", number:30, team:"defense" }));
  players.push(new Player({ x: midX+50,  y: dbY-40, role:"S", number:31, team:"defense" }));

  // Ball starts with QB
  let qb = players.find(p => p.role==="QB");
  ball.possessor = qb;
  ball.x = qb.x;
  ball.y = qb.y;
  ball.inFlight = false;
  ball.vx = 0;
  ball.vy = 0;
}

/** Basic Pass Routes (slants, go) **/
function slantLeft(player, t) {
  let startX = player.x0; 
  let startY = player.y0;
  let speedX = -20;  // px/sec left
  let speedY = -60; // px/sec up
  return { x: startX + speedX * t, y: startY + speedY * t };
}
function slantRight(player, t) {
  let startX = player.x0; 
  let startY = player.y0;
  let speedX = 20;  
  let speedY = -60; 
  return { x: startX + speedX * t, y: startY + speedY * t };
}
function goRoute(player, t) {
  // straight up
  let startX = player.x0;
  let startY = player.y0;
  let speedY = -90;
  return { x: startX, y: startY + speedY * t };
}

/** Assign pass routes to WR/TE before the snap **/
function assignPassRoutes() {
  players.forEach(p => {
    if (p.team==="offense" && (p.role==="WR"||p.role==="TE")) {
      // store initial
      p.x0 = p.x; 
      p.y0 = p.y;
      // randomly pick one of the three
      let routeChoices = [slantLeft, slantRight, goRoute];
      p.routeFn = routeChoices[Math.floor(Math.random()*routeChoices.length)];
      p.routeTime = 0;
    }
  });
}

/** RUN / PASS BUTTONS **/
const btnRun = document.getElementById("playRun");
const btnPass = document.getElementById("playPass");
function showPlayButtons(show) {
  btnRun.style.display = show ? "inline-block" : "none";
  btnPass.style.display = show ? "inline-block" : "none";
}
btnRun.addEventListener("click", () => {
  gameState.playType = "run";
  showPlayButtons(false);
});
btnPass.addEventListener("click", () => {
  gameState.playType = "pass";
  showPlayButtons(false);
  // Assign routes
  assignPassRoutes();
});

/** SNAP THE BALL (start the play) when the snapper is tapped **/
function startPlay() {
  gameState.phase = "play";
}

/** MAIN GAME LOOP **/
function gameLoop(timestamp) {
  if (!gameState.lastTime) gameState.lastTime = timestamp;
  let dt = (timestamp - gameState.lastTime)/1000;
  gameState.lastTime = timestamp;

  // Update the clock if in play
  if (gameState.phase==="play") {
    gameState.clock -= dt;
    if (gameState.clock<0) {
      gameState.clock=0;
      endQuarterOrGame();
    }
  }

  // Update players
  players.forEach(p => p.update(dt));
  // Update ball
  ball.update(dt);

  // Check collisions/tackles
  if (ball.possessor && ball.possessor.team==="offense") {
    checkTackles();
    checkTouchdown();
  }

  // Redraw
  draw();
  requestAnimationFrame(gameLoop);
}

/** Check Tackle **/
function checkTackles() {
  let bc = ball.possessor;
  players.forEach(d => {
    if (d.team==="defense") {
      let distVal = dist(d.x, d.y, bc.x, bc.y);
      if (distVal<18) {
        // Tackle
        endPlay("tackle");
      }
    }
  });
}

/** Check Touchdown **/
function checkTouchdown() {
  let bc = ball.possessor;
  // top end zone is y<100
  if (bc.y<100) {
    gameState.offenseScore += 6;
    endPlay("touchdown");
  }
}

/** End quarter or game if clock hits zero **/
function endQuarterOrGame() {
  if (gameState.quarter<gameState.totalQuarters) {
    gameState.quarter++;
    gameState.clock=15*60;
  } else {
    // end of game scenario
    gameState.clock=0;
  }
}

/** End the play & proceed **/
function endPlay(reason) {
  gameState.phase="post-play";
  if (reason==="tackle") {
    useDown();
  }
  // If "touchdown", you might do extra point logic
  setTimeout(() => {
    prepareNextPlay();
  }, 1500);
}

/** Use a down **/
function useDown() {
  gameState.down++;
  if (gameState.down>4) {
    // Turnover
    swapPossession();
  }
}

/** Swap Possession **/
function swapPossession() {
  players.forEach(p => {
    p.team = (p.team==="offense") ? "defense":"offense";
  });
  gameState.down=1;
  gameState.yardsToFirstDown=10;
  gameState.lineOfScrimmage=800;
  gameState.firstDownMarker=700;
  initFormation();
}

/** Prepare Next Play **/
function prepareNextPlay() {
  gameState.phase="pre-snap";
  showPlayButtons(true);
  // Optionally adjust LOS based on yardage gained, etc.
  initFormation();
}

/** DRAW ROUTINES **/
function draw() {
  ctx.clearRect(0,0, canvas.width, canvas.height);

  drawField();
  players.forEach(p => p.draw(ctx));
  drawBall();
  updateScoreboard();
}

function drawField() {
  // top end zone => y=0..100
  // main field => y=100..1100
  // bottom end zone => 1100..1200
  ctx.save();
  const scale = getScale();
  // fill entire
  ctx.fillStyle = "#007f0e";
  ctx.fillRect(0,0, canvas.width, canvas.height);

  // end zone top
  ctx.fillStyle = "blue";
  ctx.fillRect(0,0, canvas.width, 100*scale.sy);
  // end zone bottom
  ctx.fillStyle = "red";
  ctx.fillRect(0, 1100*scale.sy, canvas.width, 100*scale.sy);

  // yard lines from y=100 to y=1100 every 100 px
  ctx.strokeStyle = "#fff";
  ctx.lineWidth=2;
  for (let y=100; y<=1100; y+=100) {
    ctx.beginPath();
    ctx.moveTo(0, y*scale.sy);
    ctx.lineTo(canvas.width, y*scale.sy);
    ctx.stroke();
  }

  // line of scrimmage
  ctx.strokeStyle="#fff";
  ctx.beginPath();
  ctx.moveTo(0, gameState.lineOfScrimmage*scale.sy);
  ctx.lineTo(canvas.width, gameState.lineOfScrimmage*scale.sy);
  ctx.stroke();

  // first down
  ctx.strokeStyle="yellow";
  ctx.beginPath();
  ctx.moveTo(0, gameState.firstDownMarker*scale.sy);
  ctx.lineTo(canvas.width, gameState.firstDownMarker*scale.sy);
  ctx.stroke();

  ctx.restore();
}

function drawBall() {
  ctx.save();
  let scale = getScale();
  let sx = ball.x*scale.sx;
  let sy = ball.y*scale.sy;
  ctx.font = "24px serif";
  ctx.textAlign = "center";
  ctx.textBaseline="middle";
  ctx.fillText("🏈", sx, sy);
  ctx.restore();
}

function updateScoreboard() {
  document.getElementById("offenseScore").innerText = "Offense: " + gameState.offenseScore;
  document.getElementById("defenseScore").innerText = "Defense: " + gameState.defenseScore;
  document.getElementById("quarter").innerText = "Q" + gameState.quarter;
  let mm = Math.floor(gameState.clock/60);
  let ss = Math.floor(gameState.clock%60);
  let clockStr = mm + ":" + (ss<10?"0"+ss:ss);
  document.getElementById("gameClock").innerText = clockStr;
  document.getElementById("downDistance").innerText = gameState.down + " & " + gameState.yardsToFirstDown;
}

/** Scaling function from field coords to screen coords */
function getScale() {
  return {
    sx: canvas.width / FIELD_WIDTH,
    sy: canvas.height / FIELD_HEIGHT
  };
}

/** Helpers **/
function dist(ax, ay, bx, by) {
  let dx=ax-bx, dy=ay-by;
  return Math.sqrt(dx*dx + dy*dy);
}
function moveToward(obj, tx, ty, speed, dt) {
  let dx = tx - obj.x;
  let dy = ty - obj.y;
  let d = Math.sqrt(dx*dx + dy*dy);
  if (d<1) return;
  let step = speed*dt;
  if (step>d) step=d;
  let nx = dx/d;
  let ny = dy/d;
  obj.x += nx*step;
  obj.y += ny*step;
}

/** INPUT / CLICK LOGIC **/
canvas.addEventListener("click",(evt)=>{
  let rect = canvas.getBoundingClientRect();
  let mx = evt.clientX - rect.left;
  let my = evt.clientY - rect.top;
  let s = getScale();
  let fieldX = mx/s.sx;
  let fieldY = my/s.sy;

  // see if a player was clicked
  let clicked = findPlayerAt(fieldX, fieldY);
  if (clicked) {
    handlePlayerClick(clicked);
  } else {
    // If run play in action, direct the ball carrier
    if (gameState.phase==="play" && gameState.playType==="run") {
      let bc = ball.possessor;
      if (bc && bc.team==="offense") {
        bc.target = { x: fieldX, y: fieldY };
      }
    }
  }
});
function findPlayerAt(x, y) {
  for (let i=0; i<players.length; i++){
    let p = players[i];
    if (dist(x,y,p.x,p.y)<15) return p;
  }
  return null;
}

function handlePlayerClick(p) {
  if (gameState.phase==="pre-snap") {
    if (p.role==="Snapper" && p.team==="offense") {
      startPlay(); 
    }
  } else if (gameState.phase==="play") {
    // If pass play, tapping a WR or TE => pass
    if (gameState.playType==="pass" && p.team==="offense" && (p.role==="WR"||p.role==="TE")) {
      attemptPass(p);
    }
  }
}

/** Attempt a pass from QB to target p */
function attemptPass(target) {
  let qb = players.find(x => x.role==="QB" && x.team==="offense");
  if (!qb || ball.possessor!==qb) return; // Must have the ball
  // Launch the ball
  ball.possessor = null;
  ball.inFlight = true;
  // We'll let pass hang in air ~0.6s
  let passTime = 0.6;
  let dx = target.x - qb.x;
  let dy = target.y - qb.y;
  ball.vx = dx / passTime;
  ball.vy = dy / passTime;

  setTimeout(()=>{
    // If still in flight, “catch” it
    ball.inFlight=false;
    ball.possessor=target;
    ball.x=target.x;
    ball.y=target.y;
  }, passTime*1000);
}

/** Start everything **/
initFormation();
showPlayButtons(true);
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
