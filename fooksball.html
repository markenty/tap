<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Top-Down Football (More Accurate)</title>
  <style>
    /* FIELD + UI */
    body {
      margin: 0;
      background-color: #006400;
      font-family: Arial, sans-serif;
      user-select: none;
    }
    #gameCanvas {
      background-color: #007f0e;
      display: block;
      margin: 10px auto;
      border: 2px solid #fff;
    }
    #scoreboard {
      text-align: center;
      color: #fff;
      margin: 0 auto;
    }
    #scoreboard > div {
      margin: 5px 0;
    }
    span.label {
      display: inline-block;
      min-width: 100px;
      font-weight: bold;
    }
    #controls {
      text-align: center;
      color: #fff;
      margin-top: 10px;
    }
    button {
      font-size: 16px;
      padding: 8px 16px;
      margin: 0 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="900" height="650"></canvas>

<div id="scoreboard">
  <div><span class="label">Offense Score:</span> <span id="offenseScore">0</span></div>
  <div><span class="label">Defense Score:</span> <span id="defenseScore">0</span></div>
  <div><span class="label">Quarter:</span> <span id="quarter">1</span></div>
  <div><span class="label">Game Clock:</span> <span id="gameClock">15:00</span></div>
  <div>
    <span class="label">Down & Distance:</span>
    <span id="downDistance">1st & 10</span>
  </div>
</div>

<div id="controls">
  <button id="playRun" style="display:none;">Run Play</button>
  <button id="playPass" style="display:none;">Pass Play</button>
  <button id="kickFieldGoal" style="display:none;">Kick (FG/XP)</button>
</div>

<script>
/* 
   High-Level Summary of Features Implemented Here:
   1) 4 downs to gain 10 yards
   2) Offense/Defense roles, swapping on turnover
   3) Scoring: touchdown, extra point (simplified), field goal attempts, safeties
   4) Quarter and clock logic (simplified to 4 quarters, each 15 minutes)
   5) Basic AI for blocking, tackling, coverage
   6) Tap-based pass selection (QB -> receiver), run plays, manual player movement
   7) More robust state tracking (drive yard line, first down yard line, current down, etc.)
*/

/* === Canvas Setup === */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

/* === GAME STATE === */
let gameState = {
  phase: "pre-snap",     // "pre-snap", "play", "post-play", "kick"
  playType: null,        // "run", "pass", or "kick"
  selectedPlayer: null,  
  passSelection: null,   // { qb, receiver }
  lineOfScrimmage: 500,  // y‚Äêcoordinate for LOS (approx)
  firstDownY: 440,       // y‚Äêcoordinate for the next first down
  offenseScore: 0,
  defenseScore: 0,
  quarter: 1,
  clock: 15 * 60,        // 15 minutes per quarter, in seconds
  totalQuarters: 4,
  down: 1,
  yardsToFirstDown: 10,
  ballPlacementY: 500,   // Where the ball is placed at snap
  lastTimestamp: Date.now(),
  ballSpottedY: 500,     // For tracking ball position after each play
  fieldGoalRange: 80,    // Distance in Y from end zone for a FG attempt
};

/* === BALL OBJECT === */
let ball = {
  x: canvas.width / 2,
  y: gameState.lineOfScrimmage,
  possessor: null,
  inMotion: false,
  vx: 0,
  vy: 0,
  update() {
    if (!this.possessor && this.inMotion) {
      this.x += this.vx;
      this.y += this.vy;
      // basic friction
      this.vx *= 0.985;
      this.vy *= 0.985;
    } else if (this.possessor) {
      // follow the possessor
      this.x = this.possessor.x;
      this.y = this.possessor.y;
    }
  },
  draw(ctx) {
    ctx.font = "24px serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("üèà", this.x, this.y);
  }
};

/* === PLAYERS ARRAY === */
let players = [];

/* === PLAYER CLASS === */
class Player {
  constructor(id, team, number, x, y, role) {
    this.id = id;
    this.team = team;         // "offense" or "defense"
    this.number = number;
    this.x = x;
    this.y = y;
    this.role = role;         // e.g. "QB", "Snapper", "WR", "LB", "CB"
    this.speed = 1.8;
    this.target = null;       
  }

  update() {
    if (this.target) {
      let dx = this.target.x - this.x;
      let dy = this.target.y - this.y;
      let dist = Math.hypot(dx, dy);
      if (dist > 2) {
        this.x += (dx / dist) * this.speed;
        this.y += (dy / dist) * this.speed;
      } else {
        this.target = null;
      }
    } else if (gameState.phase === "play") {
      // Basic AI
      if (this.team === "offense") {
        // If you have the ball, move up the field
        if (ball.possessor === this) {
          // Move straight up by default
          this.y -= this.speed;
        } else {
          // Basic ‚Äúroute running‚Äù or blocking
          if (this.role === "WR") {
            // run some route up/down the field
            this.y -= 0.5;
            this.x += (Math.random() - 0.5);
          } else {
            // block or random small movements
            this.y -= (Math.random() * 0.2);
          }
        }
      } else {
        // Defense: pursuit if there's a ball carrier
        if (ball.possessor && ball.possessor.team === "offense") {
          let dx = ball.possessor.x - this.x;
          let dy = ball.possessor.y - this.y;
          let dist = Math.hypot(dx, dy);
          if (dist < 250) {
            this.x += (dx / dist) * this.speed * 0.9;
            this.y += (dy / dist) * this.speed * 0.9;
          }
        }
      }
    }
  }

  draw(ctx) {
    ctx.beginPath();
    ctx.arc(this.x, this.y, 15, 0, 2 * Math.PI);
    ctx.fillStyle = (this.team === "offense") ? "blue" : "red";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();
    ctx.closePath();

    ctx.fillStyle = "#fff";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(this.number, this.x, this.y);
  }
}

/* === INIT PLAYERS === */
function initPlayers() {
  players = [];
  let startX = canvas.width / 2 - 5*30; // position them horizontally
  // Offense (11 players)
  // - Quick example roles: 1 QB, 1 Snapper, 2 WR, 2 RB, 5 Linemen
  //   Just to illustrate differences
  let rolesOffense = [
    "QB", "Snapper", "WR", "WR", "RB", "RB",
    "OL", "OL", "OL", "OL", "OL"
  ];
  for (let i = 0; i < 11; i++) {
    let px = startX + i*30;
    let py = gameState.lineOfScrimmage + 30;
    players.push(new Player("O"+i, "offense", i+1, px, py, rolesOffense[i]||"OL"));
  }
  // Defense (11 players)
  // - e.g. 4 DL, 3 LB, 4 DB
  let rolesDefense = [
    "DL", "DL", "DL", "DL", "LB", "LB", "LB",
    "CB", "CB", "S", "S"
  ];
  for (let j = 0; j < 11; j++) {
    let px = startX + j*30;
    let py = gameState.lineOfScrimmage - 100;
    players.push(new Player("D"+j, "defense", j+1, px, py, rolesDefense[j]||"DL"));
  }

  // Assign ball initially to the QB on offense
  let qb = players.find(p => p.role === "QB" && p.team === "offense");
  if (qb) {
    ball.possessor = qb;
    ball.x = qb.x;
    ball.y = qb.y;
  }
}

/* === FIELD DRAWING === */
function drawField() {
  // Clear
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw yard lines
  // End zones approx: top zone is y=0 to y=50, bottom zone is y=600 to y=650
  ctx.strokeStyle = "#fff";
  let yardLineCount = 10;
  for (let i = 0; i <= yardLineCount; i++) {
    let y = 50 + i*((canvas.height - 100)/yardLineCount);
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }

  // End Zones
  ctx.fillStyle = "blue";
  ctx.fillRect(0, 0, canvas.width, 50);
  ctx.fillStyle = "red";
  ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

  // LOS (white) & First Down (yellow)
  ctx.strokeStyle = "#fff";
  ctx.beginPath();
  ctx.moveTo(0, gameState.lineOfScrimmage);
  ctx.lineTo(canvas.width, gameState.lineOfScrimmage);
  ctx.stroke();

  ctx.strokeStyle = "yellow";
  ctx.beginPath();
  ctx.moveTo(0, gameState.firstDownY);
  ctx.lineTo(canvas.width, gameState.firstDownY);
  ctx.stroke();
}

/* === DRAW FUNCTION === */
function draw() {
  drawField();
  // Draw players
  players.forEach(p => p.draw(ctx));
  // Draw ball
  ball.draw(ctx);

  // Update scoreboard
  document.getElementById("offenseScore").innerText = gameState.offenseScore;
  document.getElementById("defenseScore").innerText = gameState.defenseScore;
  document.getElementById("quarter").innerText = gameState.quarter;

  // Down & distance text
  let distLabel = gameState.down + " & " + gameState.yardsToFirstDown;
  document.getElementById("downDistance").innerText = distLabel;

  let minutes = Math.floor(gameState.clock / 60);
  let seconds = Math.floor(gameState.clock % 60);
  document.getElementById("gameClock").innerText = minutes + ":" + (seconds < 10 ? "0"+seconds : seconds);
}

/* === GAME LOOP === */
function gameLoop() {
  let now = Date.now();
  let dt = (now - gameState.lastTimestamp) / 1000; 
  gameState.lastTimestamp = now;

  // Clock update only during play
  if (gameState.phase === "play") {
    gameState.clock -= dt;
    if (gameState.clock <= 0) {
      gameState.clock = 0;
      endQuarter();
    }
  }

  // Update all
  players.forEach(p => p.update());
  ball.update();

  // Check tackles
  checkTackles();
  // Check if possession crosses LOS for yardage
  checkYardage();
  // Check Touchdown
  checkTouchdown();
  // Check Safety
  checkSafety();

  draw();
  requestAnimationFrame(gameLoop);
}

/* === TACKLES === */
function checkTackles() {
  if (ball.possessor && ball.possessor.team === "offense") {
    // For each defender, see if they collide with ball carrier
    players.forEach(d => {
      if (d.team === "defense") {
        let dx = d.x - ball.possessor.x;
        let dy = d.y - ball.possessor.y;
        let dist = Math.hypot(dx, dy);
        if (dist < 20) {
          // TACKLE: End the play
          endPlay("tackle");
        }
      }
    });
  }
}

/* === CHECK TOUCHDOWN === */
function checkTouchdown() {
  // Offense is moving upward, so if ball carrier crosses y < 50 => TD
  if (ball.possessor && ball.possessor.team === "offense") {
    if (ball.possessor.y < 50) {
      // Touchdown
      gameState.offenseScore += 6;
      endPlay("touchdown");
    }
  }
}

/* === CHECK SAFETY === */
function checkSafety() {
  // If the offense is tackled in its own end zone (bottom zone y>600 => safety)
  if (ball.possessor && ball.possessor.team === "offense" && gameState.phase === "play") {
    if (ball.possessor.y > canvas.height - 50) {
      // Safety
      gameState.defenseScore += 2;
      endPlay("safety");
    }
  }
}

/* === CHECK YARDAGE (DOWN & DISTANCE) === */
function checkYardage() {
  // The field is oriented top to bottom, so negative yard progress is decreasing y
  // Start-of-drive LOS is gameState.lineOfScrimmage, firstDownY is 10 yards up ( ~ 60 px).
  if (ball.possessor && ball.possessor.team === "offense") {
    let ballCarrierY = ball.possessor.y;
    // check if they reached first down line
    if (ballCarrierY < gameState.firstDownY) {
      // Achieved first down => reset down & new LOS
      let newLOS = ballCarrierY; // current position
      gameState.down = 1;
      gameState.lineOfScrimmage = newLOS;
      gameState.firstDownY = newLOS - 60; // 10 yards up
      gameState.yardsToFirstDown = 10;
    }
  }
}

/* === END QUARTER / GAME === */
function endQuarter() {
  // If quarter < totalQuarters, go to next quarter
  // Otherwise, game could end. For now, just go to next quarter.
  if (gameState.quarter < gameState.totalQuarters) {
    gameState.quarter++;
    gameState.clock = 15 * 60;
  } else {
    // Final => do a basic ‚Äúgame over‚Äù scenario
    gameState.clock = 0;
  }
}

/* === END PLAY === */
function endPlay(reason) {
  gameState.phase = "post-play";
  // Spot the ball at the ball carrier‚Äôs position if not a turnover
  if (ball.possessor && ball.possessor.team === "offense") {
    gameState.ballSpottedY = ball.possessor.y;
  }

  // If not a touchdown or safety, or immediate turnover, continue with next down
  if (reason === "tackle") {
    useUpDown();
  }
  if (reason === "touchdown") {
    // Show Kick button for extra point
    document.getElementById("kickFieldGoal").style.display = "inline-block";
  }
  if (reason === "safety") {
    // Turn possession over after a safety, for example
    swapPossession(true);
  }

  // Reset
  ball.inMotion = false;
  ball.vx = 0;
  ball.vy = 0;
  // Wait a second, then move to pre-snap
  setTimeout(() => {
    if (reason === "touchdown") {
      // Prompt for extra point or 2-pt attempt. 
      // For simplicity here, we show only a Kick button for FG/XP.
      // If user selects run/pass, they can do a 2-pt attempt, etc.
    } else if (reason !== "safety") {
      prepareNextPlay();
    }
  }, 1000);
}

/* === USE ONE DOWN === */
function useUpDown() {
  gameState.down++;
  let yardGained = (gameState.lineOfScrimmage - gameState.ballSpottedY) / 6; // approx yard calc
  let yardsRemaining = gameState.yardsToFirstDown - Math.round(yardGained);
  if (yardsRemaining < 0) {
    yardsRemaining = 10; 
  }
  gameState.yardsToFirstDown = yardsRemaining;

  if (gameState.down > 4) {
    // Turnover on downs
    swapPossession();
  }
}

/* === SWAP POSSESSION === */
function swapPossession(afterSafety=false) {
  if (!afterSafety) {
    // Basic turnover
    let oldOffense = players.filter(p => p.team === "offense");
    let oldDefense = players.filter(p => p.team === "defense");
    oldOffense.forEach(p => p.team = "defense");
    oldDefense.forEach(p => p.team = "offense");
  }
  // Re-init down/distance
  gameState.down = 1;
  gameState.yardsToFirstDown = 10;
  // Move LOS further down for the new offense.
  gameState.lineOfScrimmage = 500; 
  gameState.firstDownY = 440;
  gameState.ballSpottedY = 500;

  // Reassign roles if swapped
  initPlayers();
}

/* === PREP FOR NEXT PLAY === */
function prepareNextPlay() {
  gameState.phase = "pre-snap";
  // Reposition players for next snap
  players.forEach(p => {
    if (p.team === "offense") {
      p.y = gameState.lineOfScrimmage + 30;
    } else {
      p.y = gameState.lineOfScrimmage - 100;
    }
    p.x = canvas.width / 2 - 5*30 + (parseInt(p.number)-1)*30;
  });
  // Reassign ball to the offense QB
  let qb = players.find(p => p.role === "QB" && p.team === "offense");
  if (qb) {
    ball.possessor = qb;
    ball.x = qb.x;
    ball.y = qb.y;
  }

  // Show run/pass selection
  document.getElementById("playRun").style.display = "inline-block";
  document.getElementById("playPass").style.display = "inline-block";
  document.getElementById("kickFieldGoal").style.display = "none";
}

/* === PLAY SELECTION === */
document.getElementById("playRun").addEventListener("click", () => {
  gameState.playType = "run";
  document.getElementById("playRun").style.display = "none";
  document.getElementById("playPass").style.display = "none";
});

document.getElementById("playPass").addEventListener("click", () => {
  gameState.playType = "pass";
  document.getElementById("playRun").style.display = "none";
  document.getElementById("playPass").style.display = "none";
});

document.getElementById("kickFieldGoal").addEventListener("click", () => {
  // Simple FG logic: If LOS is within fieldGoalRange of the top (like 80 px),
  // attempt FG => 3 points if successful, else turnover
  if (gameState.lineOfScrimmage > 50 && gameState.lineOfScrimmage < (50 + gameState.fieldGoalRange)) {
    // basic success chance
    let success = Math.random() < 0.9; // 90% chance
    if (success) {
      // If it‚Äôs an extra point attempt after touchdown => 1 point
      // If actual FG => 3 points. For simplicity, check reason from endPlay.
      if (gameState.phase === "post-play") {
        gameState.offenseScore += 1; // XP
      } else {
        gameState.offenseScore += 3; // FG
      }
    }
  }
  endPlay("kick");
  // Next drive
  swapPossession();
});

/* === START PLAY (SNAP) === */
function startPlay() {
  gameState.phase = "play";
  // If pass, user will have to tap QB => receiver
}

/* === MOUSE EVENTS === */
canvas.addEventListener("click", (evt) => {
  let rect = canvas.getBoundingClientRect();
  let mx = evt.clientX - rect.left;
  let my = evt.clientY - rect.top;
  // Check if a player was clicked
  let clicked = players.find(p => Math.hypot(p.x - mx, p.y - my) < 15);
  if (!clicked) {
    // If a player was selected for manual movement
    if (gameState.selectedPlayer) {
      gameState.selectedPlayer.target = { x: mx, y: my };
      gameState.selectedPlayer = null;
    }
  } else {
    handlePlayerClick(clicked);
  }
});

function handlePlayerClick(p) {
  if (gameState.phase === "pre-snap") {
    // Snap the ball if p is the Snapper
    if (p.role === "Snapper" && p.team === "offense") {
      startPlay();
    } else {
      // Alternatively, reposition the player
      gameState.selectedPlayer = p;
    }
  } else if (gameState.phase === "play") {
    // If run play, tapping the ball carrier => manual target
    if (gameState.playType === "run") {
      if (ball.possessor && ball.possessor.id === p.id) {
        gameState.selectedPlayer = p;
      }
    } 
    // If pass, need to select QB => receiver
    else if (gameState.playType === "pass") {
      if (!gameState.passSelection) {
        // pick QB
        if (p.role === "QB" && p.team === "offense") {
          gameState.passSelection = { qb: p, receiver: null };
        }
      } else {
        // pick receiver
        if (p.team === "offense" && p !== gameState.passSelection.qb) {
          gameState.passSelection.receiver = p;
          executePass();
        }
      }
    }
  }
}

/* === EXECUTE PASS === */
function executePass() {
  if (!gameState.passSelection || !gameState.passSelection.qb || !gameState.passSelection.receiver) {
    return;
  }
  let qb = gameState.passSelection.qb;
  let recv = gameState.passSelection.receiver;
  // Initiate ball throw
  ball.possessor = null;
  ball.inMotion = true;
  ball.x = qb.x;
  ball.y = qb.y;
  let dx = recv.x - qb.x;
  let dy = recv.y - qb.y;
  let dist = Math.hypot(dx, dy);
  let speed = 6; // pass speed
  ball.vx = (dx / dist) * speed;
  ball.vy = (dy / dist) * speed;

  // After some time, assume receiver tries to catch
  setTimeout(() => {
    // If no defender intercepts, we give possession to the receiver
    ball.possessor = recv;
    ball.inMotion = false;
    ball.x = recv.x;
    ball.y = recv.y;
  }, 800);

  gameState.passSelection = null;
}

/* === INITIALIZE + MAIN LOOP === */
initPlayers();
draw();
gameState.lastTimestamp = Date.now();
gameLoop();

// Show run/pass on load
document.getElementById("playRun").style.display = "inline-block";
document.getElementById("playPass").style.display = "inline-block";
</script>
</body>
</html>
